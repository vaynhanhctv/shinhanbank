<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VNPT eKYC - Xác thực giấy tờ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://ekyc.vnpt.vn/admin-dashboard/assets/img/favicon.png">
    <style>
        :root {
            --colorEKYCHeaderBar: #FFFFFF;
            --colorEKYCTextContentMain: #FFFFFF;
            --colorEKYCBackgroundMain: #122F41;
            --colorEKYCLinePath: #D9D9D9;
            --colorEKYCBackgroundButton: #18D696;
            --colorEKYCTextButtonAndFeedbackBar: #142730;
            --colorEKYCBackgroundCapture: #122F41;
            --colorEKYCAnimation: #18D696;
            --colorEKYCButtonCapture: #FFFFFF;
            --colorEKYCBorderOval: #FFFFFF;
            --colorEKYCTexturesUnderBackground: #18D696;
            --colorEKYCTextContentPopup: #142730;
            --colorEKYCBackgroundPopup: #FFFFFF;
            --primary-color: var(--colorEKYCBackgroundButton);
            --secondary-color: var(--colorEKYCBackgroundMain);
            --text-color-main: var(--colorEKYCTextContentMain);
            --text-color-dark: var(--colorEKYCTextButtonAndFeedbackBar);
            --border-line-color: rgba(225, 225, 225, 0.15);
            --capture-bg-color: var(--colorEKYCBackgroundCapture);
            --animation-color: var(--colorEKYCAnimation);
            --button-capture-color: var(--colorEKYCButtonCapture);
            --border-oval-color: var(--colorEKYCBorderOval);
            --texture-color: var(--colorEKYCTexturesUnderBackground);
            --popup-text-color: var(--colorEKYCTextContentPopup);
            --popup-background-color: var(--colorEKYCBackgroundPopup);
            --error-color: #D9534F;
            --border-radius: 10px;
            --shadow: none;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --vnpt-primary-color: #18d696;
            --vnpt-text-color-default: #ffffff;
            --vnpt-background-sdk: #0F2B3B;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color-main);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .hidden { display: none !important; }
        .app-header {
            background: var(--secondary-color);
            padding: 0.75rem 1rem;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 1010;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 3.5rem;
        }
        .app-header .header-left { display: flex; align-items: center; }
        .app-header .header-left img { width: 38px; height: 12px; margin-right: 0.5rem; }
        .app-header .header-left span { color: var(--colorEKYCHeaderBar); font-weight: 600; font-size: 1rem; }
        .back-button { font-size: 1.25rem; color: var(--colorEKYCHeaderBar); cursor: pointer; padding-right: 1rem; line-height: 1; }
        .language-select { width: 8rem; background-color: #F9FAFB; border: 1px solid #F5F5F5; color: #111127; font-size: 0.875rem; border-radius: 0.5rem; padding: 0.5rem; height: auto; }
        .main-content-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-image: linear-gradient(180deg, var(--secondary-color) 70%, rgba(15, 43, 59, 0.8)), url('https://ekyc.vnpt.vn/admin-dashboard/89a76675bbd6fa410418.svg');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center bottom;
        }
        .content-card { background: transparent; padding: 0; border-radius: 0; box-shadow: none; margin: 0 auto; max-width: 28rem; }
        .document-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border-line-color); cursor: pointer; transition: background-color 0.3s ease, color 0.3s ease; position: relative; }
        .document-item:last-child { border-bottom: none; }
        .document-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .document-item:hover .document-name, .document-item:hover .arrow-icon svg { color: var(--primary-color) !important; }
        .document-icon-wrapper { width: 4rem; height: 4rem; border-radius: 0.5rem; background-color: var(--primary-color); display: flex; justify-content: center; align-items: center; flex-shrink: 0; margin-right: 1rem; }
        .document-name { flex-grow: 1; color: var(--vnpt-text-color-default); font-weight: 500; font-size: 1rem; margin-left: 0.5rem; }
        .arrow-icon { flex-shrink: 0; margin-left: 1rem; }
        .arrow-icon svg { color: var(--vnpt-text-color-default); transition: color 0.3s ease; }
        .pre-capture-guide-section { background-color: var(--popup-background-color); padding: clamp(20px, 5vw, 40px); border-radius: var(--border-radius); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); margin: 0 auto; max-width: 28rem; text-align: center; }
        .pre-capture-guide-section h3 { color: var(--text-color-dark); font-weight: 700; font-size: 1.5rem; line-height: 2rem; margin-bottom: 1rem; }
        .pre-capture-guide-section .instruction-text { color: #757575; font-size: 1rem; margin-bottom: 1.5rem; }
        .guide-examples { display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .guide-example { width: 120px; text-align: center; }
        .guide-example img { width: 100%; height: 75px; border-radius: 8px; border: 2px solid; object-fit: cover; }
        .guide-example p { margin-top: 10px; font-weight: bold; color: var(--text-color-dark); }
        .guide-example.correct img { border-color: var(--primary-color); }
        .guide-example.correct p { color: var(--primary-color); }
        .guide-example.incorrect img { border-color: var(--error-color); }
        .guide-example.incorrect p { color: var(--error-color); }
        .pre-capture-guide-section ul { list-style: none; padding: 0; text-align: left; max-width: 450px; margin: 0 auto 30px auto; }
        .pre-capture-guide-section li { margin: 15px 0; display: flex; align-items: center; font-size: 14px; color: var(--text-color-dark); }
        .pre-capture-guide-section li i { color: var(--primary-color); margin-right: 15px; width: 24px; text-align: center; font-size: 18px; }
        .capture-box, .confirm-box { text-align: center; min-height: auto; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--popup-background-color); padding: clamp(20px, 5vw, 40px); border-radius: var(--border-radius); margin-top: 1.5rem; width: 100%; }
        .capture-box h3, .confirm-box h3 { color: var(--text-color-dark); font-weight: 600; font-size: 1.25rem; margin-bottom: 0.5rem; }
        .capture-box .instruction-text, .confirm-box .instruction-text { color: #757575; font-size: 1rem; margin-bottom: 1.5rem; }
        .capture-content-state { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .capture-section.state-capturing .capture-content-state[data-state="capturing"], .capture-section.state-loading .capture-content-state[data-state="loading"], .capture-section.state-success .capture-content-state[data-state="success"], .capture-section.state-error .capture-content-state[data-state="error"] { display: flex; }
        .camera-frame { background: var(--capture-bg-color); border-radius: var(--border-radius); overflow: hidden; width: 100%; max-width: 430px; aspect-ratio: 1.586 / 1; margin: 1rem auto; position: relative; }
        .camera-frame video, .camera-frame canvas { display: block; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .camera-frame .overlay-focus { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .camera-frame .overlay-focus .id-card-outline { border: 3px solid var(--border-oval-color); box-shadow: 0 0 0 9999px var(--capture-bg-color); border-radius: var(--border-radius); width: 80%; height: 80%; position: relative; overflow: hidden; }
        .id-card-outline::before, .id-card-outline::after, .id-card-outline > span::before, .id-card-outline > span::after { content: ''; position: absolute; width: 25px; height: 25px; border-color: var(--border-oval-color); border-width: 4px; border-style: solid; border-radius: 6px; display: block; }
        .id-card-outline::before { top: 0; left: 0; border-right: none; border-bottom: none; }
        .id-card-outline::after { top: 0; right: 0; border-left: none; border-bottom: none; }
        .id-card-outline > span::before { bottom: 0; left: 0; border-right: none; border-top: none; }
        .id-card-outline > span::after { bottom: 0; right: 0; border-left: none; border-top: none; }
        .camera-frame.ready-to-capture .id-card-outline, .camera-frame.ready-to-capture .id-card-outline::before, .camera-frame.ready-to-capture .id-card-outline::after, .camera-frame.ready-to-capture .id-card-outline > span::before, .camera-frame.ready-to-capture .id-card-outline > span::after { border-color: var(--animation-color); }
        .camera-frame.blink-once { animation: blink 0.5s 1; }
        @keyframes blink { 50% { box-shadow: 0 0 20px var(--animation-color); } }
        .status-message { background-color: var(--primary-color); color: var(--text-color-dark); font-weight: 500; border-radius: 6px; display: block; margin-top: 1.5rem; font-size: 0.875rem; line-height: 1.25rem; padding: 0.75rem 1rem; width: 90%; box-sizing: border-box; text-align: center; }
        .error-message { background-color: #F8D7DA; color: var(--error-color); border: 1px solid #F5C6CB; border-radius: 6px; display: none; margin-top: 1rem; font-size: 0.875rem; padding: 0.75rem 1rem; width: 90%; text-align: center; }
        .error-message.visible { display: block; }
        .loader { width: 3rem; height: 3rem; border: 0.25rem solid rgba(0,0,0,.1); border-top-color: var(--animation-color); margin: 1.5rem auto; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .button-group { margin-top: 2rem; gap: 0.75rem; display: flex; flex-wrap: wrap; justify-content: center; width: 100%; }
        .btn { border-radius: var(--border-radius); padding: 1rem 3rem; font-weight: 700; font-size: 1.125rem; transition: var(--transition); border: none; flex-grow: 1; max-width: 200px; }
        .btn-primary { background-color: var(--primary-color); color: var(--text-color-dark); }
        .btn-primary:hover { background-color: #16C185; color: var(--text-color-dark); }
        .btn-primary:disabled { background-color: #B0BEC5; color: white; cursor: not-allowed; }
        .btn-primary.is-loading { position: relative; color: transparent !important; }
        .btn-primary.is-loading .spinner-border { display: inline-block; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: var(--text-color-dark); }
        .btn-secondary { background-color: #E8E8E8; color: var(--text-color-dark); }
        .btn-secondary:hover { background-color: #D6D6D6; color: var(--text-color-dark); }
        .confirm-previews { display: flex; flex-direction: row; flex-wrap: wrap; gap: 1.5rem; margin-top: 2rem; justify-content: center; }
        .confirm-previews img { width: 100%; max-width: 200px; height: auto; border: 1px solid #F5F5F5; border-radius: var(--border-radius); object-fit: contain; cursor: pointer; }
        .ai-review-section { background-color: var(--popup-background-color); padding: clamp(20px, 5vw, 40px); border-radius: var(--border-radius); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); margin-top: 1.5rem; text-align: left; color: var(--text-color-dark); width: 100%; box-sizing: border-box; }
        .ai-review-section h4 { color: var(--primary-color); font-weight: 700; margin-bottom: 1rem; }
        .ai-review-section p, .ai-review-section ul { margin-bottom: 0.5rem; color: #757575; }
        .ai-review-section strong { color: var(--text-color-dark); }
        .ai-review-section .spinner-border { margin-right: 0.5rem; }
        .ai-review-section ul { list-style: disc; padding-left: 20px; }
        .ai-review-section ul li { margin-bottom: 5px; }
        .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10000; cursor: zoom-out; }
        .fullscreen-modal img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: var(--border-radius); }
        @media (max-width: 640px) {
            .app-header .header-left span { display: none; }
            .language-select { margin-left: auto; width: 7rem; }
            .document-item { flex-direction: column; align-items: flex-start; }
            .document-icon-wrapper { margin-bottom: 0.5rem; margin-right: 0; }
            .document-name { margin-left: 0; margin-top: 0.25rem; }
            .arrow-icon { margin-left: auto; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); }
            .btn { padding: 0.75rem 1.5rem; font-size: 1rem; max-width: none; }
            .button-group { flex-direction: column; }
            .confirm-previews img { max-width: 100%; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-left">
            <i id="backButton" class="fas fa-arrow-left back-button hidden" aria-label="Quay lại"></i>
            <img src="https://ekyc.vnpt.vn/admin-dashboard/assets/img/logo_ekyc.svg" alt="VNPT Logo">
            <span>eKYC VNPT</span>
        </div>
        <select id="languageSelect" class="language-select">
            <option value="vi" selected>Tiếng Việt</option>
            <option value="en">English</option>
        </select>
    </header>

    <main class="main-content-wrapper">
        <div class="content-card">
            <div id="guideSection">
                <div class="guide-box">
                    <h3 data-i18n="doc_auth">Xác thực giấy tờ</h3>
                    <p data-i18n="choose_doc">Chọn giấy tờ bạn muốn xác thực</p>
                    <div class="document-selection">
                        <div class="document-item" id="selectIDCard">
                            <div class="document-icon-wrapper"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M28.3333 28H3.66675C1.64404 28 0 26.356 0 24.3333V7.66675C0 5.64404 1.64404 4 3.66675 4H28.3333C30.356 4 32 5.64404 32 7.66675V24.3333C32 26.356 30.356 28 28.3333 28ZM3.66675 6C2.74805 6 2 6.74805 2 7.66675V24.3333C2 25.252 2.74805 26 3.66675 26H28.3333C29.252 26 30 25.252 30 24.3333V7.66675C30 6.74805 29.252 6 28.3333 6H3.66675Z" fill="white"></path><path d="M10.0002 15.9998C8.16284 15.9998 6.66699 14.5037 6.66699 12.6665C6.66699 10.8291 8.16284 9.33301 10.0002 9.33301C11.8376 9.33301 13.3335 10.8291 13.3335 12.6665C13.3335 14.5037 11.8376 15.9998 10.0002 15.9998Z" fill="white"></path><path d="M15 22.6665C14.448 22.6665 14 22.2185 14 21.6665V20.9998C14 20.0811 13.252 19.333 12.3333 19.333H7.66675C6.74805 19.333 6 20.0811 6 20.9998V21.6665C6 22.2185 5.552 22.6665 5 22.6665C4.448 22.6665 4 22.2185 4 21.6665V20.9998C4 18.9771 5.64404 17.333 7.66675 17.333H12.3333C14.356 17.333 16 18.9771 16 20.9998V21.6665C16 22.2185 15.552 22.6665 15 22.6665Z" fill="white"></path><path d="M27.0002 12H19.667C19.115 12 18.667 11.552 18.667 11C18.667 10.448 19.115 10 19.667 10H27.0002C27.5522 10 28.0002 10.448 28.0002 11C28.0002 11.552 27.5522 12 27.0002 12Z" fill="white"></path><path d="M27.0002 17.333H19.667C19.115 17.333 18.667 16.885 18.667 16.333C18.667 15.781 19.115 15.333 19.667 15.333H27.0002C27.5522 15.333 28.0002 15.781 28.0002 16.333C28.0002 16.885 27.5522 17.333 27.0002 17.333Z" fill="white"></path><path d="M27.0002 22.667H19.667C19.115 22.667 18.667 22.219 18.667 21.667C18.667 21.115 19.115 20.667 19.667 20.667H27.0002C27.5522 20.667 28.0002 21.115 28.0002 21.667C28.0002 22.219 27.5522 22.667 27.0002 22.667Z" fill="white"></path></svg></div>
                            <p class="document-name" data-i18n="id_card">Chứng minh thư, Thẻ căn cước</p>
                            <div class="arrow-icon"><svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L6.25 6.25L1 11.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
                        </div>
                         <div class="document-item" id="selectPassport">
                            <div class="document-icon-wrapper"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23.2856 1.78908C23.7258 2.22756 23.9999 2.81403 23.9999 3.4581V4.74962H24.0001V3.45829C24.0001 2.81413 23.7259 2.22758 23.2856 1.78908ZM27.2794 5.54191C27.7261 5.98909 28 6.58987 28 7.24962V28.4995C28 29.8783 26.804 30.9995 25.3333 30.9995H6.66668C5.90407 30.9995 5.21534 30.6981 4.72892 30.2155C5.21536 30.6982 5.90416 30.9997 6.66688 30.9997H25.3335C26.8042 30.9997 28.0002 29.8785 28.0002 28.4997V7.24981C28.0002 6.58997 27.7262 5.98911 27.2794 5.54191ZM3.7002 7.24981C3.7002 5.74797 4.94911 4.55824 6.4776 4.46547L20.6686 0.786678C20.896 0.732732 21.0982 0.702107 21.3306 0.699847C22.9084 0.684698 24.3001 1.90366 24.3001 3.45829V4.44981H25.3335C26.9514 4.44981 28.3001 5.68743 28.3002 7.24981V28.4997C28.3002 30.0622 26.9513 31.2997 25.3335 31.2997H6.66688C5.04897 31.2997 3.7002 30.0621 3.7002 28.4997V7.24981ZM22.3134 2.64158C22.0054 2.33605 21.5375 2.177 21.0802 2.28643L11.5795 4.74962H11.5786L21.08 2.28623C21.5374 2.17678 22.0054 2.33592 22.3134 2.64158ZM16.0001 7.80029C11.846 7.80029 8.4668 11.1795 8.4668 15.3336C8.4668 19.4876 11.846 22.8668 16.0001 22.8668C20.1541 22.8668 23.5334 19.4876 23.5334 15.3336C23.5334 11.1795 20.1541 7.80029 16.0001 7.80029Z" fill="white"></path></svg></div>
                            <p class="document-name" data-i18n="passport">Hộ chiếu</p>
                            <div class="arrow-icon"><svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L6.25 6.25L1 11.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
                        </div>
                        <div class="document-item" id="selectDriverLicense">
                             <div class="document-icon-wrapper"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.8477 22.1685H3.53195C2.59904 22.1685 1.83943 21.4121 1.83943 20.4833V5.79307H30.0408V18.2893C30.0408 18.7949 30.4527 19.2051 30.9605 19.2051C31.4683 19.2051 31.8803 18.7949 31.8803 18.2893V3.5768C31.8803 1.63675 30.2967 0.0600586 28.3483 0.0600586H3.53195C1.58357 0.0599976 0 1.63676 0 3.5768V20.4833C0 22.4233 1.58358 24 3.53195 24H13.8477C14.3571 24 14.7675 23.5894 14.7675 23.0842C14.7675 22.5787 14.3555 22.1685 13.8477 22.1685ZM12.0003 10.621C12.0003 12.088 10.807 13.2762 9.33366 13.2762C7.86033 13.2762 6.66699 12.088 6.66699 10.621C6.66699 9.15401 7.86033 7.96581 9.33366 7.96581C10.807 7.96581 12.0003 9.15401 12.0003 10.621ZM9.33301 13.6079C8.49554 13.6079 7.3343 13.8733 6.36125 14.3908C5.42012 14.8913 4.33301 15.815 4.33301 17.2588V19.5821H14.333V17.2588C14.333 15.815 13.2459 14.8913 12.3048 14.3908C11.3317 13.8733 10.1705 13.6079 9.33301 13.6079Z" fill="white"></path><path d="M30.1295 23.4813L29.2587 22.6105L28.573 18.8389C28.414 17.9662 27.6559 17.3333 26.769 17.3333H19.8977C19.0108 17.3333 18.2527 17.9662 18.0937 18.8389L17.408 22.6105L16.5372 23.4813C16.1907 23.8274 16 24.288 16 24.778V27.4166C16 27.6696 16.2053 27.8749 16.4583 27.8749H30.2083C30.4613 27.8749 30.6667 27.6696 30.6667 27.4166V24.778C30.6667 24.288 30.476 23.8274 30.1295 23.4813Z" fill="white"></path></svg></div>
                             <p class="document-name" data-i18n="driver_license">Bằng lái xe</p>
                            <div class="arrow-icon"><svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L6.25 6.25L1 11.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
                        </div>
                        <div class="document-item" id="selectMilitaryID">
                            <div class="document-icon-wrapper"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 12L2 7" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 12L22 7" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 12V22" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
                            <p class="document-name" data-i18n="military_id">Chứng minh Quân đội</p>
                            <div class="arrow-icon"><svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L6.25 6.25L1 11.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
                        </div>
                        <div class="document-item" id="selectOtherDocument">
                            <div class="document-icon-wrapper"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14 25C14 25.5523 13.5523 26 13 26H7C6.44772 26 6 25.5523 6 25C6 24.4477 6.44772 24 7 24H13C13.5523 24 14 24.4477 14 25ZM22 19C22 19.5523 21.5523 20 21 20H7C6.44772 20 6 19.5523 6 19C6 18.4477 6.44772 18 7 18H21C21.5523 18 22 18.4477 22 19ZM22 13C22 13.5523 21.5523 14 21 14H7C6.44772 14 6 13.5523 6 13C6 12.4477 6.44772 12 7 12H21C21.5523 12 22 12.4477 22 13Z" fill="white"></path><path d="M4 6H24V30H4V6ZM25 4H3C2.448 4 2 4.448 2 5V31C2 31.552 2.448 32 3 32H25C25.552 32 26 31.552 26 31V5C26 4.448 25.552 4 25 4Z" fill="white"></path><path d="M30 29H28V2H5V0H29C29.552 0 30 0.448 30 1V29Z" fill="white"></path></svg></div>
                            <p class="document-name" data-i18n="other_doc">Giấy tờ khác</p>
                            <div class="arrow-icon"><svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L6.25 6.25L1 11.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
                        </div>
                    </div>
                    <div id="initStatusMessageContainer"></div>
                </div>
            </div>

            <div id="preCaptureGuideSection" class="hidden pre-capture-guide-section">
                <h3 id="preCaptureTitle"></h3>
                <p id="preCaptureInstruction" class="instruction-text"></p>
                <div class="guide-examples">
                    <div class="guide-example correct">
                        <img id="guideCorrectImg" src="" alt="Ảnh chụp đúng">
                        <p data-i18n="valid_photo">Ảnh hợp lệ</p>
                    </div>
                    <div class="guide-example incorrect">
                        <img id="guideIncorrectImg" src="" alt="Ảnh chụp sai">
                        <p data-i18n="invalid_photo">Ảnh không hợp lệ</p>
                    </div>
                </div>
                <ul>
                    <li data-i18n="guide_1"><i class="fas fa-image"></i> Đặt giấy tờ trên một mặt phẳng, màu tối.</li>
                    <li data-i18n="guide_2"><i class="fas fa-lightbulb"></i> Đảm bảo môi trường đủ sáng, không bị lóa.</li>
                    <li data-i18n="guide_3"><i class="fas fa-crop-alt"></i> Canh chỉnh toàn bộ giấy tờ nằm gọn trong khung hình.</li>
                    <li data-i18n="guide_4"><i class="fas fa-mobile-alt"></i> Giữ điện thoại ổn định để ảnh không bị mờ.</li>
                </ul>
                <div class="button-group">
                    <button id="startCameraButton" class="btn btn-primary" data-i18n="start_capture">Bắt đầu chụp</button>
                </div>
            </div>

            <div id="captureSection" class="hidden capture-section">
                <div class="capture-box">
                    <div>
                        <h3 id="captureTitle"></h3>
                        <p id="captureInstruction" class="instruction-text"></p>
                    </div>
                    <div class="capture-content-state" data-state="capturing">
                       <div class="camera-frame" id="cameraFrame">
                            <video id="cameraVideo" autoplay playsinline class="hidden"></video>
                            <canvas id="cameraCanvasPreview"></canvas>
                            <div class="overlay-focus"><div class="id-card-outline"><span></span></div></div>
                        </div>
                    </div>
                    <div class="capture-content-state" data-state="loading">
                        <div id="loader" class="loader"></div>
                        <p class="instruction-text" data-i18n="processing_image">Đang xử lý ảnh...</p>
                    </div>
                    <div class="capture-content-state" data-state="success">
                        <i class="fas fa-check-circle fa-4x" style="color: var(--animation-color); margin: 1.5rem auto;"></i>
                        <p class="h5" style="color: var(--text-color-dark);" data-i18n="capture_success">Chụp ảnh thành công!</p>
                    </div>
                    <div class="capture-content-state" data-state="error">
                         <div class="camera-frame" id="cameraFrameError">
                            <video id="cameraVideoError" autoplay playsinline class="hidden"></video>
                            <canvas id="cameraCanvasPreviewError"></canvas>
                            <div class="overlay-focus"><div class="id-card-outline"><span></span></div></div>
                        </div>
                    </div>
                    <div>
                        <p id="statusMessage" class="status-message" aria-live="polite"></p>
                        <div id="errorMessage" class="error-message" role="alert"></div>
                        <div class="button-group">
                            <button id="manualCaptureBtn" class="btn btn-secondary"><i class="fas fa-camera"></i><span data-i18n="manual_capture" style="margin-left: 8px;">Chụp ảnh</span></button>
                            <button id="recaptureBtn" class="btn btn-secondary hidden"><i class="fas fa-redo"></i><span data-i18n="recapture" style="margin-left: 8px;">Chụp lại</span></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="confirmSection" class="hidden">
                <div class="confirm-box">
                    <div>
                        <h3 data-i18n="confirm_info">Xác nhận thông tin</h3>
                        <p class="instruction-text" data-i18n="confirm_check_photos">Vui lòng kiểm tra lại hình ảnh đã chụp.</p>
                    </div>
                    <div class="confirm-previews">
                        <img id="frontPreview" alt="Ảnh mặt trước">
                        <img id="backPreview" alt="Ảnh mặt sau">
                    </div>
                    <div class="button-group">
                        <button id="redoFrontBtn" class="btn btn-secondary" data-i18n="recapture_front">Chụp lại mặt trước</button>
                        <button id="redoBackBtn" class="btn btn-secondary" data-i18n="recapture_back">Chụp lại mặt sau</button>
                    </div>
                    <div class="button-group">
                        <button id="aiReviewBtn" class="btn btn-primary w-100 mb-3">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span data-i18n="ai_review">✨ AI Review Data ✨</span>
                        </button>
                        <button id="confirmFinalBtn" class="btn btn-primary w-100">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span data-i18n="confirm_complete">Xác nhận và Hoàn tất</span>
                        </button>
                    </div>
                    <div id="aiReviewResult" class="ai-review-section hidden mt-4 w-100">
                        <h4 data-i18n="ai_result_title">Kết quả phân tích AI:</h4>
                        <div id="aiReviewContent" aria-live="polite"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
    <script type="module">
        "use strict";

        const IDCaptureApp = {
            state: {
                frontImageVerified: false,
                backImageVerified: false,
                frontImageDataUrl: null,
                backImageDataUrl: null,
                currentStream: null,
                currentCaptureType: null,
                isAutoCapturing: false,
                autoCaptureTimeoutId: null,
                autoCaptureMaxTimeoutId: null,
                simulationAttempts: 0,
                isCardDetected: false,
                cameraCanvasPreview: null,
                cameraCanvasContext: null,
                animationFrameId: null,
                tesseractWorker: null,
                isTesseractInitializing: false,
                extractedInfo: null,
                currentScreen: 'guideSection',
                isAiReviewing: false,
            },
            elements: {},
            config: {
                AUTO_CAPTURE_INTERVAL: 1000,
                ERROR_MESSAGE_TIMEOUT: 5000,
                MAX_CAPTURE_TIMEOUT: 30000,
                BACKEND_API_URL: 'https://httpbin.org/post',
                NEXT_STEP_URL: 'https://example.com/next-step',
                IMAGE_UPLOAD_MAX_WIDTH: 1920,
                GUIDE_IMAGES: {
                    'idcard': { correct: 'https://vaytieudung.github.io/shinhanbank/lib/sdkweb1.png', incorrect: 'https://vaytieudung.github.io/shinhanbank/lib/errorweb1.png' },
                    'passport': { correct: 'https://placehold.co/120x75/18D696/FFFFFF?text=Valid', incorrect: 'https://placehold.co/120x75/D9534F/FFFFFF?text=Invalid' },
                    'driverlicense': { correct: 'https://placehold.co/120x75/18D696/FFFFFF?text=Valid', incorrect: 'https://placehold.co/120x75/D9534F/FFFFFF?text=Invalid' },
                    'militaryid': { correct: 'https://placehold.co/120x75/18D696/FFFFFF?text=Valid', incorrect: 'https://placehold.co/120x75/D9534F/FFFFFF?text=Invalid' },
                    'other': { correct: 'https://placehold.co/120x75/18D696/FFFFFF?text=Valid', incorrect: 'https://placehold.co/120x75/D9534F/FFFFFF?text=Invalid' },
                    'face': { correct: 'https://vaytieudung.github.io/shinhanbank/lib/IMG_3266.PNG', incorrect: 'https://vaytieudung.github.io/shinhanbank/lib/IMG_3268.PNG' }
                },
                i18n: {
                    vi: {
                        doc_auth: "Xác thực giấy tờ",
                        choose_doc: "Chọn giấy tờ bạn muốn xác thực",
                        id_card: "Chứng minh thư, Thẻ căn cước",
                        passport: "Hộ chiếu",
                        driver_license: "Bằng lái xe",
                        military_id: "Chứng minh Quân đội",
                        other_doc: "Giấy tờ khác",
                        valid_photo: "Ảnh hợp lệ",
                        invalid_photo: "Ảnh không hợp lệ",
                        guide_1: "Đặt giấy tờ trên một mặt phẳng, màu tối.",
                        guide_2: "Đảm bảo môi trường đủ sáng, không bị lóa.",
                        guide_3: "Canh chỉnh toàn bộ giấy tờ nằm gọn trong khung hình.",
                        guide_4: "Giữ điện thoại ổn định để ảnh không bị mờ.",
                        start_capture: "Bắt đầu chụp",
                        processing_image: "Đang xử lý ảnh...",
                        capture_success: "Chụp ảnh thành công!",
                        manual_capture: "Chụp ảnh",
                        recapture: "Chụp lại",
                        confirm_info: "Xác nhận thông tin",
                        confirm_check_photos: "Vui lòng kiểm tra lại hình ảnh đã chụp.",
                        recapture_front: "Chụp lại mặt trước",
                        recapture_back: "Chụp lại mặt sau",
                        ai_review: "✨ AI Review Data ✨",
                        confirm_complete: "Xác nhận và Hoàn tất",
                        ai_result_title: "Kết quả phân tích AI:",
                        ocr_loading: "Đang tải mô hình nhận dạng OCR...",
                        ocr_downloading: "Đang tải dữ liệu OCR:",
                        ocr_initializing: "Đang khởi tạo OCR...",
                        ocr_ready: "Hệ thống đã sẵn sàng!",
                        ocr_error: "Lỗi tải mô hình OCR. Vui lòng thử lại.",
                        resume_prompt: "Chúng tôi tìm thấy dữ liệu từ phiên làm việc trước. Bạn có muốn tiếp tục không?",
                        no_network: "Không có kết nối mạng. Vui lòng kiểm tra lại."
                    },
                    en: {
                        doc_auth: "Document Authentication",
                        choose_doc: "Choose the document to authenticate",
                        id_card: "ID Card",
                        passport: "Passport",
                        driver_license: "Driver's License",
                        military_id: "Military ID",
                        other_doc: "Other Document",
                        valid_photo: "Valid Photo",
                        invalid_photo: "Invalid Photo",
                        guide_1: "Place document on a flat, dark surface.",
                        guide_2: "Ensure enough light, avoid glare.",
                        guide_3: "Fit the entire document inside the frame.",
                        guide_4: "Hold the phone steady to avoid blur.",
                        start_capture: "Start Capture",
                        processing_image: "Processing image...",
                        capture_success: "Capture successful!",
                        manual_capture: "Capture",
                        recapture: "Recapture",
                        confirm_info: "Confirm Information",
                        confirm_check_photos: "Please review the captured images.",
                        recapture_front: "Retake Front",
                        recapture_back: "Retake Back",
                        ai_review: "✨ AI Review Data ✨",
                        confirm_complete: "Confirm and Complete",
                        ai_result_title: "AI Analysis Result:",
                        ocr_loading: "Loading OCR model...",
                        ocr_downloading: "Downloading OCR data:",
                        ocr_initializing: "Initializing OCR...",
                        ocr_ready: "System is ready!",
                        ocr_error: "Error loading OCR model. Please try again.",
                        resume_prompt: "We found data from a previous session. Would you like to resume?",
                        no_network: "No network connection. Please check and try again."
                    }
                }
            },
            
            async init() {
                this.cacheDOMElements();
                if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
                    this.showPermanentError("Trình duyệt không hỗ trợ camera.");
                    return;
                }
                this.addEventListeners();
                this.updateLanguage(this.elements.languageSelect.value);
                this.checkSavedProgress();
                console.log("eKYC App initialized.");
            },

            async initTesseract() {
                if (this.state.tesseractWorker || this.state.isTesseractInitializing) return;
                
                this.state.isTesseractInitializing = true;
                const statusContainer = this.elements.initStatusMessageContainer;
                statusContainer.innerHTML = `<p id="initStatusMessage" class="status-message mt-3" style="animation: none;" aria-live="polite"></p>`;
                const statusMsg = statusContainer.querySelector('#initStatusMessage');
                const docItems = document.querySelectorAll('.document-item');
                docItems.forEach(item => item.style.pointerEvents = 'none');
                
                try {
                    const lang = this.elements.languageSelect.value;
                    statusMsg.textContent = this.config.i18n[lang].ocr_loading;
                    statusMsg.style.display = 'block';
                    
                    this.state.tesseractWorker = await Tesseract.createWorker('vie', 1, {
                        logger: m => {
                            if (m.status.startsWith('downloading')) {
                                statusMsg.textContent = `${this.config.i18n[lang].ocr_downloading} ${Math.round(m.progress * 100)}%`;
                            } else if (m.status.startsWith('initializing')) {
                                statusMsg.textContent = this.config.i18n[lang].ocr_initializing;
                            }
                        }
                    });
                    statusMsg.textContent = this.config.i18n[lang].ocr_ready;
                    statusMsg.style.backgroundColor = 'var(--primary-color)';
                    setTimeout(() => statusMsg.style.display = 'none', 2000);
                } catch (error) {
                    console.error("Failed to initialize Tesseract:", error);
                    const lang = this.elements.languageSelect.value;
                    statusMsg.textContent = this.config.i18n[lang].ocr_error;
                    statusMsg.style.backgroundColor = 'var(--error-color)';
                } finally {
                    this.state.isTesseractInitializing = false;
                    docItems.forEach(item => item.style.pointerEvents = 'auto');
                }
            },

            cacheDOMElements() {
                const ids = ['guideSection', 'preCaptureGuideSection', 'captureSection', 'cameraFrame', 'cameraVideo', 'statusMessage', 'loader', 'errorMessage', 'manualCaptureBtn', 'recaptureBtn', 'captureTitle', 'captureInstruction', 'backButton', 'confirmSection', 'frontPreview', 'backPreview', 'redoFrontBtn', 'redoBackBtn', 'confirmFinalBtn', 'cameraCanvasPreview', 'startCameraButton', 'guideCorrectImg', 'guideIncorrectImg', 'aiReviewBtn', 'aiReviewResult', 'aiReviewContent', 'languageSelect', 'initStatusMessageContainer', 'preCaptureTitle', 'preCaptureInstruction'];
                ids.forEach(id => this.elements[id] = document.getElementById(id));
                this.elements.selectIDCard = document.getElementById('selectIDCard');
                this.elements.selectPassport = document.getElementById('selectPassport');
                this.elements.selectDriverLicense = document.getElementById('selectDriverLicense');
                this.elements.selectMilitaryID = document.getElementById('selectMilitaryID');
                this.elements.selectOtherDocument = document.getElementById('selectOtherDocument');
                this.state.cameraCanvasPreview = this.elements.cameraCanvasPreview;
                if (this.state.cameraCanvasPreview) {
                    this.state.cameraCanvasContext = this.state.cameraCanvasPreview.getContext('2d');
                }
            },

            addEventListeners() {
                this.elements.selectIDCard?.addEventListener('click', () => this.showPreCaptureGuide('idcard'));
                this.elements.selectPassport?.addEventListener('click', () => this.showPreCaptureGuide('passport'));
                this.elements.selectDriverLicense?.addEventListener('click', () => this.showPreCaptureGuide('driverlicense'));
                this.elements.selectMilitaryID?.addEventListener('click', () => this.showPreCaptureGuide('militaryid'));
                this.elements.selectOtherDocument?.addEventListener('click', () => this.showPreCaptureGuide('other'));
                this.elements.startCameraButton?.addEventListener('click', () => this.startCameraFromGuide());
                this.elements.manualCaptureBtn?.addEventListener('click', () => this.triggerCapture(false));
                this.elements.recaptureBtn?.addEventListener('click', () => this.startCaptureProcess(this.state.currentCaptureType));
                this.elements.backButton?.addEventListener('click', () => this.handleBackButtonClick());
                this.elements.redoFrontBtn?.addEventListener('click', () => this.retakePhoto('front'));
                this.elements.redoBackBtn?.addEventListener('click', () => this.retakePhoto('back'));
                this.elements.confirmFinalBtn?.addEventListener('click', () => this.submitFinalData());
                this.elements.aiReviewBtn?.addEventListener('click', () => this.handleAIReview());
                this.elements.languageSelect?.addEventListener('change', (e) => this.updateLanguage(e.target.value));
            },

            async showPreCaptureGuide(type) {
                await this.initTesseract();
                if (this.state.isTesseractInitializing) return;

                localStorage.setItem('currentCaptureType', type);
                this.state.currentCaptureType = type;
                this.state.currentScreen = 'preCaptureGuideSection';
                this.elements.guideSection.classList.add('hidden');
                this.elements.captureSection.classList.add('hidden');
                this.elements.confirmSection.classList.add('hidden');
                this.elements.preCaptureGuideSection.classList.remove('hidden');
                this.elements.backButton.classList.remove('hidden');

                let titleText = '', instructionText = '';
                switch (type) {
                    case 'idcard':
                        titleText = 'Hướng dẫn chụp ảnh CMND/CCCD';
                        instructionText = 'Vui lòng đặt CMND/CCCD vào khung hình và đảm bảo ảnh rõ nét.';
                        break;
                    case 'passport':
                        titleText = 'Hướng dẫn chụp ảnh Hộ chiếu';
                        instructionText = 'Vui lòng mở trang thông tin cá nhân của hộ chiếu và đặt vào khung hình.';
                        break;
                    case 'driverlicense':
                        titleText = 'Hướng dẫn chụp ảnh Bằng lái xe';
                        instructionText = 'Vui lòng đặt Bằng lái xe vào khung hình và đảm bảo ảnh rõ nét.';
                        break;
                    case 'militaryid':
                        titleText = 'Hướng dẫn chụp ảnh Chứng minh Quân đội';
                        instructionText = 'Vui lòng đặt Chứng minh Quân đội vào khung hình và đảm bảo ảnh rõ nét.';
                        break;
                    default:
                        titleText = 'Hướng dẫn chụp ảnh Giấy tờ';
                        instructionText = 'Vui lòng đặt giấy tờ vào khung hình và đảm bảo ảnh rõ nét.';
                        break;
                }
                this.elements.preCaptureTitle.textContent = titleText;
                this.elements.preCaptureInstruction.textContent = instructionText;
                this.elements.guideCorrectImg.src = this.config.GUIDE_IMAGES[type].correct;
                this.elements.guideIncorrectImg.src = this.config.GUIDE_IMAGES[type].incorrect;
                this.updateLanguage(this.elements.languageSelect.value);
            },

            startCameraFromGuide() {
                this.elements.preCaptureGuideSection.classList.add('hidden');
                this.state.currentScreen = 'captureSection';
                this.startCaptureProcess(this.state.currentCaptureType);
            },

            async startCaptureProcess(type) {
                if (!this.state.tesseractWorker) {
                    this.showError("Chức năng OCR chưa sẵn sàng.", false);
                    return;
                }
                this.state.currentCaptureType = type;
                this.state.simulationAttempts = 0;
                this.state.isCardDetected = false;
                this.resetUIForCapture(type);
                await this.stopCamera();

                try {
                    const constraints = { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } } };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.state.currentStream = stream;
                    this.elements.cameraVideo.srcObject = stream;
                    this.elements.cameraVideo.onloadedmetadata = () => {
                        const frame = this.elements.cameraFrame;
                        this.state.cameraCanvasPreview.width = frame.offsetWidth;
                        this.state.cameraCanvasPreview.height = frame.offsetHeight;
                        this.drawVideoToCanvas();
                        this.autoCaptureLoop();
                    };
                    await this.elements.cameraVideo.play();
                } catch (err) {
                    let message = "Không thể truy cập camera.";
                    if (err.name === "NotAllowedError") message = "Quyền truy cập camera bị từ chối. Vui lòng cấp quyền trong cài đặt trình duyệt.";
                    await this.showPermanentError(message);
                }
            },

            drawVideoToCanvas() {
                if (!this.state.currentStream || !this.state.currentStream.active || this.elements.cameraVideo.paused) {
                    this.state.animationFrameId = null;
                    return;
                }
                const { cameraCanvasPreview: canvas, cameraCanvasContext: context } = this.state;
                const video = this.elements.cameraVideo;
                const aRatio = video.videoWidth / video.videoHeight;
                let dw, dh, dx, dy;
                if (canvas.width / canvas.height > aRatio) {
                    dw = canvas.width; dh = canvas.width / aRatio;
                    dx = 0; dy = (canvas.height - dh) / 2;
                } else {
                    dh = canvas.height; dw = canvas.height * aRatio;
                    dy = 0; dx = (canvas.width - dw) / 2;
                }
                context.drawImage(video, dx, dy, dw, dh);
                this.state.animationFrameId = requestAnimationFrame(() => this.drawVideoToCanvas());
            },

            autoCaptureLoop() {
                if (!this.state.currentStream || this.state.isAutoCapturing) return;

                if (!this.state.autoCaptureMaxTimeoutId) {
                    this.state.autoCaptureMaxTimeoutId = setTimeout(() => {
                        this.showError("Không thể tự động chụp. Vui lòng chụp thủ công.", false);
                        this.stopAutoCapture();
                    }, this.config.MAX_CAPTURE_TIMEOUT);
                }

                const { isValid, message, isCardDetected, shouldCapture } = this.simulateValidation();
                this.state.isCardDetected = isCardDetected;
                this.setCameraFrameReady(isCardDetected && isValid);
                this.elements.statusMessage.textContent = message;
                this.elements.statusMessage.style.display = 'block';

                if (shouldCapture && !this.state.isAutoCapturing) {
                    this.triggerCapture(true);
                } else {
                    this.state.autoCaptureTimeoutId = setTimeout(() => this.autoCaptureLoop(), 500);
                }
            },

            triggerCapture(isAuto = false) {
                if (this.state.isAutoCapturing) return;
                this.state.isAutoCapturing = true;
                this.stopAutoCapture();
                if (this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);

                this.toggleUIState('loading');
                this.elements.cameraFrame.classList.add('blink-once');
                
                setTimeout(() => {
                    const imageDataUrl = this.state.cameraCanvasPreview.toDataURL('image/jpeg', 0.9);
                    this.elements.cameraFrame.classList.remove('blink-once');
                    this.handleImageVerification(imageDataUrl);
                }, 500);
            },

            async handleImageVerification(imageDataUrl) {
                let verificationPassed = true, verificationMessage = "";
                if (this.state.currentCaptureType === 'idcard') {
                    const ocrResult = await this.runOCR(imageDataUrl);
                    if (!ocrResult.ocrSuccess) {
                        verificationPassed = false;
                        verificationMessage = ocrResult.message;
                    }
                }
                
                if (verificationPassed) {
                    const { isValid, message } = this.simulateValidationAfterCapture();
                    if (!isValid) {
                        verificationPassed = false;
                        verificationMessage = message;
                    }
                }

                if (verificationPassed) this.handleVerificationSuccess(imageDataUrl);
                else this.handleVerificationFailure(verificationMessage);
            },

            async runOCR(imageDataUrl) {
                if (!this.state.tesseractWorker) return { ocrSuccess: false, message: "OCR chưa sẵn sàng." };
                this.elements.statusMessage.textContent = "Đang nhận dạng chữ...";
                try {
                    const optimizedImage = await this.optimizeImageForOCR(imageDataUrl);
                    const { data: { text } } = await this.state.tesseractWorker.recognize(optimizedImage);
                    if (/\b\d{12}\b/.test(text)) return { ocrSuccess: true };
                    return { ocrSuccess: false, message: "Không tìm thấy số CCCD hợp lệ. Vui lòng thử lại." };
                } catch (error) {
                    return { ocrSuccess: false, message: "Không thể nhận dạng ảnh." };
                }
            },

            optimizeImageForOCR(dataUrl) {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const targetWidth = 800;
                        canvas.width = targetWidth;
                        canvas.height = targetWidth * (img.height / img.width);
                        ctx.filter = 'grayscale(100%) contrast(150%)';
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg'));
                    };
                    img.src = dataUrl;
                });
            },

            simulateValidation() {
                this.state.simulationAttempts++;
                const isDetected = this.state.simulationAttempts >= 2;
                const isValid = this.state.simulationAttempts >= 4;
                const shouldCapture = this.state.simulationAttempts === 5;
                let message = !isDetected ? "Đang tìm kiếm giấy tờ..." : !isValid ? "Đã tìm thấy. Vui lòng giữ yên..." : "Sẵn sàng chụp!";
                return { isValid, message, isCardDetected, shouldCapture };
            },

            simulateValidationAfterCapture() {
                if (Math.random() < 0.2) return { isValid: false, message: "Ảnh bị mờ hoặc lóa. Vui lòng chụp lại." };
                return { isValid: true, message: "Ảnh hợp lệ." };
            },

            handleVerificationSuccess(imageDataUrl) {
                this.state.isAutoCapturing = false;
                this.stopCamera();
                const type = this.state.currentCaptureType;
                if (type === 'idcard') {
                    if (!this.state.frontImageVerified) {
                        this.state.frontImageDataUrl = imageDataUrl;
                        this.state.frontImageVerified = true;
                        localStorage.setItem('frontImageDataUrl', imageDataUrl);
                        this.toggleUIState('success');
                        setTimeout(() => this.startCaptureProcess('idcard'), 1500);
                    } else {
                        this.state.backImageDataUrl = imageDataUrl;
                        this.state.backImageVerified = true;
                        localStorage.setItem('backImageDataUrl', imageDataUrl);
                        this.toggleUIState('success');
                        setTimeout(() => this.showConfirmationScreen(), 1000);
                    }
                } else {
                    this.state.frontImageDataUrl = imageDataUrl;
                    this.state.frontImageVerified = true;
                    localStorage.setItem('frontImageDataUrl', imageDataUrl);
                    this.toggleUIState('success');
                    setTimeout(() => this.showConfirmationScreen(), 1000);
                }
                this.triggerHapticFeedback();
                this.setCameraFrameReady(false);
            },

            handleVerificationFailure(message) {
                this.state.isAutoCapturing = false;
                this.showError(message || "Ảnh không hợp lệ. Vui lòng thử lại.", true);
                this.toggleUIState('error');
                if (this.state.currentStream) {
                    this.state.simulationAttempts = 0;
                    this.drawVideoToCanvas();
                    this.autoCaptureLoop();
                }
            },

            async stopCamera() {
                if (this.state.currentStream) {
                    this.state.currentStream.getTracks().forEach(track => track.stop());
                    this.state.currentStream = null;
                }
                this.elements.cameraVideo.srcObject = null;
                this.stopAutoCapture();
                if (this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);
            },

            stopAutoCapture() {
                if (this.state.autoCaptureTimeoutId) clearTimeout(this.state.autoCaptureTimeoutId);
                if (this.state.autoCaptureMaxTimeoutId) clearTimeout(this.state.autoCaptureMaxTimeoutId);
                this.state.autoCaptureTimeoutId = null;
                this.state.autoCaptureMaxTimeoutId = null;
            },

            showError(message, autoHide) {
                this.elements.errorMessage.textContent = message;
                this.elements.errorMessage.classList.add('visible');
                if (autoHide) {
                    setTimeout(() => this.elements.errorMessage.classList.remove('visible'), this.config.ERROR_MESSAGE_TIMEOUT);
                }
            },

            async showPermanentError(message) {
                await this.stopCamera();
                const guideBox = this.elements.guideSection.querySelector('.guide-box');
                if (guideBox) {
                    guideBox.innerHTML = `<div class="error-message visible" style="margin-bottom:20px;">${message}</div><button onclick="window.location.reload()" class="btn btn-primary">Thử lại</button>`;
                }
                this.elements.guideSection.classList.remove('hidden');
                this.elements.captureSection.classList.add('hidden');
                this.elements.preCaptureGuideSection.classList.add('hidden');
            },

            showConfirmationScreen() {
                this.stopCamera();
                this.elements.captureSection.classList.add('hidden');
                this.elements.confirmSection.classList.remove('hidden');
                this.elements.backButton.classList.remove('hidden');
                this.state.currentScreen = 'confirmSection';
                
                this.elements.frontPreview.src = this.state.frontImageDataUrl;
                this.elements.frontPreview.onclick = () => this.showFullScreen(this.state.frontImageDataUrl);
                
                if (this.state.currentCaptureType === 'idcard') {
                    this.elements.backPreview.src = this.state.backImageDataUrl || 'https://placehold.co/200x126/E8E8E8/AFAFAF?text=Chưa+chụp';
                    this.elements.backPreview.style.display = 'block';
                    this.elements.redoBackBtn.classList.remove('hidden');
                    if (this.state.backImageDataUrl) {
                        this.elements.backPreview.onclick = () => this.showFullScreen(this.state.backImageDataUrl);
                    }
                } else {
                    this.elements.backPreview.style.display = 'none';
                    this.elements.redoBackBtn.classList.add('hidden');
                }
                this.elements.aiReviewResult.classList.add('hidden');
            },

            showFullScreen(imageDataUrl) {
                const modal = document.createElement('div');
                modal.className = 'fullscreen-modal';
                modal.innerHTML = `<img src="${imageDataUrl}" alt="Phóng to ảnh">`;
                modal.onclick = () => modal.remove();
                document.body.appendChild(modal);
            },
            
            async dataURLtoFile(dataUrl, filename) {
                const res = await fetch(dataUrl);
                const blob = await res.blob();
                return new File([blob], filename, { type: blob.type });
            },

            async submitFinalData() {
                if (!navigator.onLine) {
                    const lang = this.elements.languageSelect.value;
                    this.showError(this.config.i18n[lang].no_network, false);
                    return;
                }

                const btn = this.elements.confirmFinalBtn;
                btn.disabled = true;
                btn.classList.add('is-loading');

                try {
                    const resizedFront = await this.resizeImageForUpload(this.state.frontImageDataUrl);
                    const frontFile = await this.dataURLtoFile(resizedFront, 'front.jpg');
                    const formData = new FormData();
                    formData.append('file', frontFile);

                    if (this.state.backImageDataUrl) {
                        const resizedBack = await this.resizeImageForUpload(this.state.backImageDataUrl);
                        const backFile = await this.dataURLtoFile(resizedBack, 'back.jpg');
                        formData.append('file_back', backFile);
                    }

                    const response = await fetch(this.config.BACKEND_API_URL, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                    
                    localStorage.clear();
                    window.location.href = this.config.NEXT_STEP_URL;
                } catch (err) {
                    console.error("Submit error:", err);
                    this.showError("Lỗi gửi dữ liệu. Vui lòng thử lại.", false);
                    btn.disabled = false;
                    btn.classList.remove('is-loading');
                }
            },

            retakePhoto(type) {
                this.elements.confirmSection.classList.add('hidden');
                if (type === 'front') {
                    this.state.frontImageVerified = false;
                    this.state.frontImageDataUrl = null;
                    if (this.state.currentCaptureType === 'idcard') {
                        this.state.backImageVerified = false;
                        this.state.backImageDataUrl = null;
                    }
                } else {
                    this.state.backImageVerified = false;
                    this.state.backImageDataUrl = null;
                }
                this.startCaptureProcess(this.state.currentCaptureType);
            },

            handleBackButtonClick() {
                switch(this.state.currentScreen) {
                    case 'preCaptureGuideSection': this.cancelCapture(); break;
                    case 'captureSection':
                        this.stopCamera();
                        this.elements.captureSection.classList.add('hidden');
                        this.elements.preCaptureGuideSection.classList.remove('hidden');
                        this.state.currentScreen = 'preCaptureGuideSection';
                        break;
                    case 'confirmSection':
                        this.elements.confirmSection.classList.add('hidden');
                        this.state.frontImageVerified = false; this.state.backImageVerified = false;
                        this.startCaptureProcess(this.state.currentCaptureType);
                        break;
                }
            },

            cancelCapture() {
                this.stopCamera();
                this.elements.captureSection.classList.add('hidden');
                this.elements.confirmSection.classList.add('hidden');
                this.elements.preCaptureGuideSection.classList.add('hidden');
                this.elements.guideSection.classList.remove('hidden');
                this.elements.backButton.classList.add('hidden');
                this.state.currentScreen = 'guideSection';
                this.state.frontImageVerified = false; this.state.backImageVerified = false;
                this.state.frontImageDataUrl = null; this.state.backImageDataUrl = null;
                localStorage.clear();
            },

            resetUIForCapture(type) {
                this.elements.guideSection.classList.add('hidden');
                this.elements.confirmSection.classList.add('hidden');
                this.elements.preCaptureGuideSection.classList.add('hidden');
                this.elements.captureSection.classList.remove('hidden');
                this.elements.backButton.classList.remove('hidden');
                this.toggleUIState('capturing');
                
                let title = '', instruction = '';
                if (type === 'idcard') {
                    const side = this.state.frontImageVerified ? 'mặt sau' : 'mặt trước';
                    title = `Chụp ${side} CCCD/CMND`;
                    instruction = `Vui lòng đặt ${side} vào trong khung hình.`;
                } else {
                    title = `Chụp ảnh ${this.getDocumentTypeName(type)}`;
                    instruction = `Vui lòng đặt ${this.getDocumentTypeName(type)} vào khung hình.`;
                }
                this.elements.captureTitle.textContent = title;
                this.elements.captureInstruction.textContent = instruction;
                this.setCameraFrameReady(false);
            },

            setCameraFrameReady(isReady) {
                this.elements.cameraFrame.classList.toggle('ready-to-capture', isReady);
            },

            triggerHapticFeedback() {
                if (navigator.vibrate) navigator.vibrate(50);
            },

            toggleUIState(state) {
                this.elements.captureSection.className = `capture-section state-${state}`;
                this.elements.manualCaptureBtn.classList.toggle('hidden', state === 'loading' || state === 'success');
                this.elements.recaptureBtn.classList.toggle('hidden', state !== 'success');
                this.elements.errorMessage.classList.remove('visible');
                this.elements.statusMessage.style.display = 'none';
            },

            getDocumentTypeName(type) {
                const names = { idcard: 'CMND/CCCD', passport: 'Hộ chiếu', driverlicense: 'Bằng lái xe', militaryid: 'CM Quân đội', face: 'chân dung', other: 'giấy tờ khác' };
                return names[type] || 'tài liệu';
            },

            async handleAIReview() {
                if (this.state.isAiReviewing) return;
                if (!navigator.onLine) {
                    const lang = this.elements.languageSelect.value;
                    this.showError(this.config.i18n[lang].no_network, true);
                    return;
                }

                this.state.isAiReviewing = true;
                this.elements.aiReviewBtn.disabled = true;
                this.elements.aiReviewBtn.classList.add('is-loading');
                this.elements.aiReviewResult.classList.remove('hidden');
                this.elements.aiReviewContent.innerHTML = `<div class="spinner-border text-primary" role="status"></div> Đang phân tích...`;

                try {
                    let ocrText = "Sample data for " + this.state.currentCaptureType;
                    const prompt = `Bạn là một trợ lý phân tích dữ liệu giấy tờ. Phân tích văn bản OCR sau, trích xuất thông tin chính, tóm tắt và chỉ ra các vấn đề tiềm ẩn. Văn bản: "${ocrText}" Trả về JSON với các trường: "document_type", "extracted_data", "summary", "potential_issues".`;
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: { "document_type": { "type": "STRING" }, "extracted_data": { "type": "OBJECT", "additionalProperties": { "type": "STRING" } }, "summary": { "type": "STRING" }, "potential_issues": { "type": "ARRAY", "items": { "type": "STRING" } } },
                                required: ["document_type", "extracted_data", "summary", "potential_issues"]
                            }
                        }
                    };

                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content) {
                        const parsedResult = JSON.parse(result.candidates[0].content.parts[0].text);
                        let html = `<p><strong>Loại giấy tờ:</strong> ${parsedResult.document_type || 'N/A'}</p><ul>`;
                        for (const key in parsedResult.extracted_data) {
                            html += `<li><strong>${key}:</strong> ${parsedResult.extracted_data[key]}</li>`;
                        }
                        html += `</ul><p><strong>Tóm tắt:</strong> ${parsedResult.summary}</p>`;
                        if (parsedResult.potential_issues.length > 0) {
                            html += `<p style="color:var(--error-color);"><strong>Vấn đề:</strong></p><ul>${parsedResult.potential_issues.map(i => `<li style="color:var(--error-color);">${i}</li>`).join('')}</ul>`;
                        } else {
                            html += `<p style="color:var(--primary-color);">Không có vấn đề tiềm ẩn.</p>`;
                        }
                        this.elements.aiReviewContent.innerHTML = html;
                    } else {
                        throw new Error("Invalid API response structure.");
                    }
                } catch (error) {
                    console.error("AI Review Error:", error);
                    this.elements.aiReviewContent.innerHTML = `<p style="color:var(--error-color);">Lỗi phân tích AI: ${error.message}</p>`;
                } finally {
                    this.state.isAiReviewing = false;
                    this.elements.aiReviewBtn.disabled = false;
                    this.elements.aiReviewBtn.classList.remove('is-loading');
                }
            },
            
            updateLanguage(lang) {
                document.documentElement.lang = lang;
                const strings = this.config.i18n[lang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (strings[key]) {
                        el.textContent = strings[key];
                    }
                });
            },
            
            checkSavedProgress() {
                const savedFront = localStorage.getItem('frontImageDataUrl');
                if (savedFront) {
                    const lang = this.elements.languageSelect.value;
                    if (confirm(this.config.i18n[lang].resume_prompt)) {
                        this.state.frontImageDataUrl = savedFront;
                        this.state.frontImageVerified = true;
                        this.state.currentCaptureType = localStorage.getItem('currentCaptureType') || 'idcard';
                        
                        const savedBack = localStorage.getItem('backImageDataUrl');
                        if (savedBack && this.state.currentCaptureType === 'idcard') {
                            this.state.backImageDataUrl = savedBack;
                            this.state.backImageVerified = true;
                        }
                        this.showConfirmationScreen();
                    } else {
                        localStorage.clear();
                    }
                }
            },
            
            async resizeImageForUpload(dataUrl) {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => {
                        const maxWidth = this.config.IMAGE_UPLOAD_MAX_WIDTH;
                        if (img.width <= maxWidth) {
                            resolve(dataUrl); return;
                        }
                        const canvas = document.createElement('canvas');
                        const ratio = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * ratio;
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.85));
                    };
                    img.src = dataUrl;
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => IDCaptureApp.init());
    </script>
</body>
</html>
